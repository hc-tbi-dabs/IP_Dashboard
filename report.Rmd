---
title: "HPFB Project Dashboard"
# header-includes:
# - \usepackage{pdflscape}
# - \newcommand{\blandscape}{\begin{landscape}}
# - \newcommand{\elandscape}{\end{landscape}}
output: pdf_document
  
always_allow_html: yes
---

```{r,echo=FALSE}
knitr::opts_chunk$set(echo=FALSE,warning=FALSE,message=FALSE)
```

Created on `r format(Sys.Date(),"%B %d,%Y")`

# Overall Portofolio:
## Project: `r ip_selected()$ips`

This reports presents the project portofolio. Project health is evaluated by three components: Deliverability of funtional elements, budget status and schedule. An interactive dashboard can be found at [shiny.hres.ca/IP_dashboard](shiny.hres.ca/IP_dashboard)

* Color code rules:
   + *Red:* Significant course correction may be required. One or more of the intended project outputs may not be achieved. Identified changes may negatively impact the project's scope, cost or schedule and significant course correction may be required. 
   + *Green:* The project is on track. The intended project outputs are expected to be achieved. Identified changes are not expected to negatively impact the project's scope, cost or schedule. 
   + *Yellow:* Some course correction may be required. One or more of the intended project outputs may not be achieved. Identified changes may negatively impact the project's scope, cost or schedule and some course correction may be required.

### Overall Project Health

```{r,message=FALSE,warning=FALSE}
 cols<-c('On Track'='#00B050','Caution'='#FFC000','Elevated Risk'='#C00000')
    
    df<-all_proj%>%
      filter(`Overall Project Health`!='Blue')%>%
      filter(IP %in% ip_selected()$ips)%>%
      group_by(status)%>%
      summarise(IP=paste(paste0('IP:',IP),collapse='\n'),count=n())
    
    p1<-ggplot(df,aes(x=status,y=count,fill=status))+geom_col()+
      scale_fill_manual(values=cols)+
      scale_y_continuous(breaks=c(0,1,2,3,4))+
      geom_text(aes(y=count,label=IP),position=position_dodge(width=0.9),vjust=1.5)+
      geom_text(aes(label=as.character(count)),position=position_dodge(width=0.9),vjust=-0.5)+
      guides(fill=F)+
      theme_minimal()+
      theme(axis.title.x=element_blank(),
            axis.text.x =element_text(size=12),
            axis.title.y =element_blank(),
            legend.title=element_blank()
      )
    
    p1
    
```

### Stage & Project Health
```{r,fig.width=8}
cols<-c('On Track'='#00B050','Caution'='#FFC000','Elevated Risk'='#C00000','Not Available'='#1f77b4')
    
    df2<-all_proj%>%
      filter(IP %in% ip_selected()$ips)%>%
      group_by(stage,status)%>%
      summarise(IP=paste(paste0('IP:',IP),collapse='\n'),count=n())
    
    p2<-ggplot(df2,aes(x=stage,y=count,fill=status))+geom_col(position='dodge')+
      scale_fill_manual(values=cols)+
      scale_y_continuous(breaks=c(0,1,2,3,4))+
      geom_text(aes(y=count-0.5,label=IP),position=position_dodge(width=0.9))+
      geom_text(aes(label=as.character(count)),position=position_dodge(width=0.9),vjust=-0.5)+
      theme_minimal()+
      theme(axis.title.x=element_blank(),
            axis.text.x =element_text(size=12),
            axis.title.y =element_blank(),
            legend.title=element_blank()
      )
    
    p2
```

### Project functionality
```{r,warning=FALSE,message=FALSE}
summary<-functionality%>%
      filter(IP %in% ip_selected()$ips)%>%
      dplyr::count(`Functionality Met? (Y/N)`)
    
    colnames(summary)<-c('status','count')
    
    status_color<-data.frame(status=c("YES", "NO"),
                             color=c( "#00b050","#C00000"))
    
    summary<-left_join(summary,status_color)
    
    plot_ly(summary,x=~status,y=~count,type='bar',
            marker=list(color=as.character(summary$color)))%>%
      layout(showlegend = F,
             xaxis=list(title=''),
             yaxis=list(title=''))%>%
      add_annotations(x=summary$`Functionality Met? (Y/N)`,
                      y=summary$count+3,
                      text=summary$count,
                      showarrow=F)
```


### Budget
##### Breakdown by Year
```{r,fig.width=10}
 ds2<-budget_yr%>%filter(IP %in% ip_selected()$ips)%>%
                    group_by(var,Year)%>%
                    summarise(value=sum(value,na.rm=T))
    budget_plot(ds2)+theme(axis.text.x = element_text(angle = 45))
```

```{r}
 ds3<-budget_yr%>%filter(IP %in% ip_selected()$ips)%>%
      group_by(var,Year)%>%
      summarise(value=sum(value,na.rm=T))%>%
      mutate(value=dollar(value))%>%
      spread(var,value)
    
knitr::kable(ds3)
```

##### Projections
```{r,fig.height=5}
ds<-budget%>%filter(IP %in% ip_selected()$ips)%>%
                 summarise(`Approved Budget`=sum(`Approved Budget`,na.rm=T),
                `Expenditure to Date`=sum(expenditure_to_date,na.rm=T),
                `Remaining budget projected`=sum(`Variance between remaining approved budget projected spending`,na.rm=T))%>%
                 gather(cat)
    
    budget_plot2(ds)
```


### Schedule
```{r,message=FALSE,warning=FALSE,fig.width=12}
df<-schedule_overview()
    
    if(input$selectdir=='All'){
      df<-df%>%
        filter(grepl('Go live',Major.Milestone,ignore.case=T))
    }
    
    shiny::validate((
      need(any(!is.na(df$Approved_finish_date)),'There is no information on project schedule')
    ))
    
    timeplot(df)
```

```{r}
df<-schedule_overview()%>%
      filter(grepl('Start Date|End Date|Go live',Major.Milestone,ignore.case=T))%>%
      select(Milestone=Major.Milestone,`Actual/Forecasted Finish Date`=Approved_finish_date)
    
knitr::kable(df)
```


### Project Risks
```{r}
proj_risk%>%
        filter(IP %in% ip_selected()$ips & !is.na(Risk))%>%
        count(Risk,sort=TRUE)%>%
        mutate(Risk=reorder(Risk,n))%>%
        ggplot(aes(x=Risk,y=n))+geom_col(fill='#1f77b4')+
        scale_y_continuous(breaks=c(0,2,4,6,8))+
        labs(x='',y='')+
        geom_text(aes(label=n,hjust=-1))+
        coord_flip()+
        theme_minimal()+
        theme(axis.title.x=element_blank(),
              axis.text.x =element_text(size=10),
              axis.text.y =element_text(size=11),
              axis.title.y =element_blank())   
```

### Project Issues
```{r}
 proj_issue%>%
        filter(IP %in% ip_selected()$ips & !is.na(Issue))%>%
        count(Issue,sort=TRUE)%>%
        mutate(Issue=reorder(Issue,n))%>%
        ggplot(aes(x=Issue,y=n))+geom_col(fill='#1f77b4')+
        scale_y_continuous(breaks=c(0,2,4,6,8))+
        labs(x='',y='')+
        geom_text(aes(label=n,hjust=-1))+
        coord_flip()+
        theme_minimal()+
        theme(axis.title.x=element_blank(),
              axis.text.x =element_text(size=10),
              axis.text.y =element_text(size=11),
              axis.title.y =element_blank())  
```

<!-- \newpage -->
#Individual Portofolio:
```{r}
project_health<-all_proj%>%filter(IP == ip_selected()$ip)%>%pull(status)
project_stage<-all_proj%>%filter(IP ==input$selectip)%>%pull(stage)
```

## Project: `r ip_selected()$ip`

### Project Health : `r project_health `
### Stage : `r project_stage`

### Budget
##### Breakdown by Year
```{r,fig.width=10}
ds5<-budget_yr%>%filter(IP==input$selectip)
budget_plot(ds5)+theme(axis.text.x = element_text(angle = 45))
```

```{r}
ds6<-budget_yr%>%filter(IP==input$selectip)%>%
                    mutate(value=dollar(value))%>%
                    spread(var,value)
    
knitr::kable(ds6)
```

##### Projection
```{r,fig.height=5}
ds4<-budget%>%filter(IP==input$selectip)%>%
                 summarise(`Approved Budget`=sum(`Approved Budget`,na.rm=T),
                           `Expenditure to Date`=sum(expenditure_to_date,na.rm=T),
                           `Remaining Budget Projected`=sum(`Variance between remaining approved budget projected spending`,na.rm=T))%>%
                 gather(cat)
    
    budget_plot2(ds4)
```

### Schedule
```{r,message=FALSE,warning=FALSE,fig.width=12}
df5<-schedule%>%filter(IP==ip_selected()$ip)
    
timeplot(df5)
    
```

```{r}
df<-schedule%>%filter(IP==ip_selected()$ip)%>%
        #filter(grepl('Start Date|End Date|Go live',Major.Milestone,ignore.case=T))%>%
        select(Milestone=Major.Milestone,Date=Approved_finish_date)
    
knitr::kable(df)
```

<!-- \newpage -->
<!-- \blandscape -->

### Project Risks

```{r}
proj_risk%>%filter(IP == input$selectip)%>%
                      select(3:7)%>%
                      knitr::kable()
```


### Project Issues
```{r}
proj_issue%>%filter(IP == input$selectip)%>%
        select(3:7)%>%
        knitr::kable()
      
```


<!-- \elandscape -->