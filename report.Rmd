---
title: "HPFB Project Dashboard"
output: 
  pdf_document:
    latex_engine: xelatex
    sansfont: Calibri
always_allow_html: yes
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{float}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{colortbl}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
---

```{r,echo=FALSE}
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(echo=FALSE,warning=FALSE,message=FALSE)
options(knitr.table.format='latex')
```

Created on `r format(Sys.Date(),"%B %d,%Y")`

# Overall Portofolio:
## Project: `r ip_selected()$ips`

This reports presents the project portofolio. Project health is evaluated by three components: Deliverability of funtional elements, budget status and schedule. An interactive dashboard can be found at [shiny.hres.ca/IP_dashboard](shiny.hres.ca/IP_dashboard)

* Color code rules:
   + *Red:* Significant course correction may be required. One or more of the intended project outputs may not be achieved. Identified changes may negatively impact the project's scope, cost or schedule and significant course correction may be required. 
   + *Green:* The project is on track. The intended project outputs are expected to be achieved. Identified changes are not expected to negatively impact the project's scope, cost or schedule. 
   + *Yellow:* Some course correction may be required. One or more of the intended project outputs may not be achieved. Identified changes may negatively impact the project's scope, cost or schedule and some course correction may be required.

### Overall Project Health

```{r,message=FALSE,warning=FALSE}
 cols<-c('On Track'='#00B050','Caution'='#FFC000','Elevated Risk'='#C00000')
    
   df<-all_proj%>%
      filter(`Overall Project Health`!='Blue')%>%
      filter(IP %in% ip_selected()$ips)%>%
      left_join(budget[,c('IP','Approved Budget')])
    
    df$status<-factor(df$status,levels=c('On Track','Caution','Elevated Risk'))
    
    p<-df%>%
      ggplot(aes(x=status,y=`Approved Budget`,size=`Approved Budget`,color=status,text=dollar(`Approved Budget`)))+
      scale_color_manual(values=cols)+
      geom_point()+
      geom_text(aes(label=paste0('IP',IP)),size=2.5,nudge_x=0.25,check_overlap = TRUE)+
      scale_size_continuous(range=c(3,30))+
      scale_y_continuous(limits=c(0,17000000),labels = dollar_y)+
      theme_minimal()+
      theme(axis.title.x=element_blank(),
            axis.text.x =element_text(size=10),
            legend.position ="none")
    p
    
```

### Stage & Project Health
```{r,fig.width=10}
cols<-c('On Track'='#00B050','Caution'='#FFC000','Elevated Risk'='#C00000','Not yet started'='#1f77b4')
    
    df<-all_proj%>%
      filter(IP %in% ip_selected()$ips)%>%
      group_by(stage,status)%>%
      summarise(IP=paste(paste0('IP',IP),collapse='\n'),count=n())
    
    df$status<-factor(df$status,levels=c('On Track','Caution','Elevated Risk','Not yet started'))
    
    p<-ggplot(df,aes(x=stage,y=count,fill=status))+geom_col(position='dodge')+
      scale_fill_manual(values=cols)+
      scale_y_continuous(breaks=c(0,1,2,3,4))+
      geom_text(aes(y=count-0.5,label=IP),position=position_dodge(width=0.9))+
      geom_text(aes(label=as.character(count)),position=position_dodge(width=0.9),vjust=-0.5)+
      theme_minimal()+
      theme(axis.title.x=element_blank(),
            axis.text.x =element_text(size=12),
            axis.title.y =element_blank(),
            legend.title=element_blank()
      )
    
    p
    
```

### Project functionality
```{r,warning=FALSE,message=FALSE}
summary<-functionality%>%
      filter(IP %in% ip_selected()$ips)%>%
      dplyr::count(`Functionality Met? (Y/N)`)
    
    colnames(summary)<-c('status','count')
    
    status_color<-data.frame(status=c("YES", "NO"),
                             color=c( "#00b050","#C00000"))
    
    summary<-left_join(summary,status_color)
    
    plot_ly(summary,x=~status,y=~count,type='bar',
            marker=list(color=as.character(summary$color)))%>%
      layout(showlegend = F,
             xaxis=list(title=''),
             yaxis=list(title=''))%>%
      add_annotations(x=summary$`Functionality Met? (Y/N)`,
                      y=summary$count+3,
                      text=summary$count,
                      showarrow=F)
```


### Budget
##### Breakdown by Year
```{r,fig.width=10}
 ds2<-budget_yr%>%filter(IP %in% ip_selected()$ips)%>%
                    group_by(var,Year)%>%
                    summarise(value=sum(value,na.rm=T))
    budget_plot(ds2)+theme(axis.text.x = element_text(angle = 45))
```

```{r}
 ds3<-budget_yr%>%filter(IP %in% ip_selected()$ips)%>%
      group_by(var,Year)%>%
      summarise(value=sum(value,na.rm=T))%>%
      mutate(value=dollar(value))%>%
      spread(var,value)
    
knitr::kable(ds3)
```

##### Projections
```{r,fig.width=10}
ds<-budget%>%filter(IP %in% ip_selected()$ips)%>%
                 summarise(`Approved Budget`=sum(`Approved Budget`,na.rm=T),
                `Expenditure to Date`=sum(expenditure_to_date,na.rm=T),
                `Remaining budget projected`=sum(`Variance between remaining approved budget projected spending`,na.rm=T))%>%
                 gather(cat)
    
    budget_plot2(ds)
```
\newpage
\blandscape

### Schedule
```{r,message=FALSE,warning=FALSE,fig.width=12}
df<-schedule_overview()
    
    if(input$selectdir=='All'){
      df<-df%>%
        filter(grepl('Go live',Major.Milestone,ignore.case=T))
    }
    
    shiny::validate((
      need(any(!is.na(df$Approved_finish_date)),'There is no information on project schedule')
    ))
    
    timeplot(df)
```

```{r}
df<-schedule_overview()%>%
      filter(grepl('Start Date|End Date|Go live',Major.Milestone,ignore.case=T))%>%
      select(Milestone=Major.Milestone,`Actual/Forecasted Finish Date`=Approved_finish_date)
    
knitr::kable(df,format='latex',
                booktabs= TRUE,
                longtable=FALSE)
```
\elandscape

\newpage

#Individual Portofolio:
```{r}
project_health<-all_proj%>%filter(IP == ip_selected()$ip)%>%pull(status)
project_stage<-all_proj%>%filter(IP ==input$selectip)%>%pull(stage)
project_stage<-gsub('\n',' ',project_stage)
```


## `r paste0('IP',ip_selected()$ip)`
### `r paste0('Project Health : ',project_health) `
### `r paste0('Stage : ',project_stage)`

### Budget
##### Breakdown by Year

```{r,fig.width=10}
ds5<-budget_yr%>%filter(IP==input$selectip)
budget_plot(ds5)+theme(axis.text.x = element_text(angle = 45))
```

```{r}
ds6<-budget_yr%>%filter(IP==input$selectip)%>%
                    mutate(value=dollar(value))%>%
                    spread(var,value)
    
knitr::kable(ds6)
```

\newpage
##### Projections
```{r,fig.width=10}
ds4<-budget%>%filter(IP==input$selectip)%>%
                 summarise(`Approved Budget`=sum(`Approved Budget`,na.rm=T),
                           `Expenditure to Date`=sum(expenditure_to_date,na.rm=T),
                           `Remaining Budget Projected`=sum(`Variance between remaining approved budget projected spending`,na.rm=T))%>%
                 gather(cat)
    
    budget_plot2(ds4)
```

\newpage
\blandscape

### Schedule
```{r,message=FALSE,warning=FALSE,fig.width=12}
df5<-schedule%>%filter(IP==ip_selected()$ip)
    
timeplot(df5)
    
```

```{r}
df<-schedule%>%filter(IP==ip_selected()$ip)%>%
        #filter(grepl('Start Date|End Date|Go live',Major.Milestone,ignore.case=T))%>%
        select(Milestone=Major.Milestone,Date=Approved_finish_date)
    
knitr::kable(df)
```


### Project Risks

```{r}
proj_risk%>%filter(IP == input$selectip)%>%
                      select(3:7)%>%
                      kable('latex',booktabs=T)%>%
                      kable_styling(full_width=F)%>%
                      column_spec(2,width='10em')%>%
                      column_spec(5,width='20em')
```


### Project Issues
```{r}
proj_issue%>%filter(IP == input$selectip)%>%
        select(3:7)%>%
        kable('latex',booktabs=T)%>%
        kable_styling(full_width=F)%>%
        column_spec(2,width='10em')%>%
        column_spec(5,width='20em')
      
```

\elandscape
